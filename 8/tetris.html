<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            overflow: hidden;
        }
        #wrap {
            height: 100vh;
            display: grid;
            grid-template-columns: 100px 200px 100px;
            column-gap: 16px;
            justify-content: center;
            align-items: center;
        }
        .side {
            width: 100px;
            height: 400px;
            border-radius: 8px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #board {
            width: 200px;
            height: 400px;
            margin: 0 auto;
            border: 2px solid black;
            background-color: #000;
        }
        .mini {
            display: gird;
            background: #000;
            border: 1px solid black;
            border-radius: 6px;
        }
        .mini.big {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 20px);
            grid-template-rows: repeat(4, 20px);
        }
        .mini.small {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4,15px);
            grid-template-rows: repeat(4,15px);
        }
        .cell {
            width: 20px;
            height: 20px;
            box-sizing: border-box;
            border: 1px dotted gray;
            background-color: #000;
        }
        .mcell {
            width: 20px;
            height: 20px;
            box-sizing: border-box;
            border: 1px dotted gray;
            background-color: #000;
        }
        .mmcell {
            width: 15px;
            height: 15px;
            box-sizing: border-box;
            border: 1px dotted gray;
            background-color: #000;
        }
        #btn,#reBtn {
            width: 130px;
            height: 50px;
            background-color: rgb(220, 151, 220);
        }
        #bwrap {
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        #title {
            color: rgb(206, 210, 250);
            font-size: 45px;
            font-style: oblique;
        }
        #level, #reLevel {
            background-color: rgb(231, 231, 184);
            width: 60px;
            height: 25px;
        }
        #hwrap {
            height: 400px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        #over {
            color: rgb(206, 210, 250);
            font-size: 32px;
            font-style: italic;
        }
        #result {
            color: rgb(200, 239, 181);
            font-size: 25px;
        }
    </style>
</head>
<body>
    
    <div id="wrap">

        <div class="side" id="left">
            <div id="hold" class="mini big"></div>
            <div id="lev"></div>
            <div id="score"></div>
        </div>

        <div id="board">

            <div id="bwrap">
                <div id="title">TETRIS</div>
                <div>.</div>
                <button id="btn">START</button>
                <select id="level">
                    <option value="1" selected="selected">Lv.1</option>
                    <option value="2">Lv.2</option>
                    <option value="3">Lv.3</option>
                    <option value="4">Lv.4</option>
                    <option value="5">Lv.5</option>
                    <option value="6">Lv.6</option>
                    <option value="7">Lv.7</option>
                    <option value="8">Lv.8</option>
                    <option value="9">Lv.9</option>
                    <option value="10">Lv.10</option>
                </select>
            </div>

            <div id="hwrap">
                <div id="over">GAME OVER</div>
                <div id="result"></div>
                <button id="reBtn">RESTART</button>
                <select id="reLevel">
                    <option value="1" selected="selected">Lv.1</option>
                    <option value="2">Lv.2</option>
                    <option value="3">Lv.3</option>
                    <option value="4">Lv.4</option>
                    <option value="5">Lv.5</option>
                    <option value="6">Lv.6</option>
                    <option value="7">Lv.7</option>
                    <option value="8">Lv.8</option>
                    <option value="9">Lv.9</option>
                    <option value="10">Lv.10</option>
                </select>
            </div>
            
        </div>

        <div class="side" id="right">
            <div id="next1" class="mini big"></div>
            <div id="next2" class="mini small"></div>
            <div id="next3" class="mini small"></div>
        </div>

    </div>

    <script>
        
        const w = 10;
        const h = 20;
        const boardEl = document.getElementById('board');
        const miniEl = document.getElementsByClassName('mini');
        let cells = [];

        function initRender() {
            boardEl.style.display = "grid";
            boardEl.style.gridTemplateColumns = "repeat(10, 20px)";
            boardEl.style.gridTemplateRows = "repeat(20, 20px)";
            for (let y=0;y<h;y++) {
                const row = [];
                for (let x=0;x<w;x++) {
                    const div = document.createElement('div');
                    div.className = 'cell';
                    boardEl.appendChild(div);
                    row.push(div);
                }
                cells.push(row);
            };
            for (let j=0;j<4;j++) {
                const row = [];
                for (let i=0;i<4;i++) {
                    const div = document.createElement('div');
                    div.className = 'mcell';
                    miniEl[0].appendChild(div);
                    row.push(div);
                }
                hcells.push(row);
            };
            for (let j=0;j<4;j++) {
                const row = [];
                for (let i=0;i<4;i++) {
                    const div = document.createElement('div');
                    div.className = 'mcell';
                    miniEl[1].appendChild(div);
                    row.push(div);
                }
                ncells0.push(row);
            };
            for (let j=0;j<4;j++) {
                const row = [];
                for (let i=0;i<4;i++) {
                    const div = document.createElement('div');
                    div.className = 'mmcell';
                    miniEl[2].appendChild(div);
                    row.push(div);
                }
                ncells1.push(row);
            };
            for (let j=0;j<4;j++) {
                const row = [];
                for (let i=0;i<4;i++) {
                    const div = document.createElement('div');
                    div.className = 'mmcell';
                    miniEl[3].appendChild(div);
                    row.push(div);
                }
                ncells2.push(row);
            };
        };

        let hcells = [];
        let ncells0 = [];
        let ncells1 = [];
        let ncells2 = [];

        let board = Array.from({length: h}, () => Array(w).fill(0));

        const colors = ["#000",
                        "#4cc9f0",
                        "#f72585",
                        "#b5179e",
                        "#ffd166",
                        "#06d6a0",
                        "#8338ec",
                        "#ef476f"];
        
        const blocks = [null,
            {id:1, name:'I', r: [
                [[0,1],[1,1],[2,1],[3,1]],
                [[2,0],[2,1],[2,2],[2,3]],
                [[0,2],[1,2],[2,2],[3,2]],
                [[1,0],[1,1],[1,2],[1,3]]
            ]},
            {id:2, name:'J', r: [
                [[0,0],[0,1],[1,1],[2,1]],
                [[1,0],[2,0],[1,1],[1,2]],
                [[0,1],[1,1],[2,1],[2,2]],
                [[1,0],[1,1],[0,2],[1,2]]
            ]},
            { id:3, name:'L', r: [
                [[2,0],[0,1],[1,1],[2,1]],
                [[1,0],[1,1],[1,2],[2,2]],
                [[0,1],[1,1],[2,1],[0,2]],
                [[0,0],[1,0],[1,1],[1,2]]
            ]},
            { id:4, name:'O', r: [
                [[1,0],[2,0],[1,1],[2,1]],
                [[1,0],[2,0],[1,1],[2,1]],
                [[1,0],[2,0],[1,1],[2,1]],
                [[1,0],[2,0],[1,1],[2,1]]
            ]},
            { id:5, name:'S', r: [
                [[1,0],[2,0],[0,1],[1,1]],
                [[1,0],[1,1],[2,1],[2,2]],
                [[1,1],[2,1],[0,2],[1,2]],
                [[0,0],[0,1],[1,1],[1,2]]
            ]},
            { id:6, name:'T', r: [
                [[1,0],[0,1],[1,1],[2,1]],
                [[1,0],[1,1],[2,1],[1,2]],
                [[0,1],[1,1],[2,1],[1,2]],
                [[1,0],[0,1],[1,1],[1,2]]
            ]},
            { id:7, name:'Z', r: [
                [[0,0],[1,0],[1,1],[2,1]],
                [[2,0],[1,1],[2,1],[1,2]],
                [[0,1],[1,1],[1,2],[2,2]],
                [[1,0],[0,1],[1,1],[0,2]]
            ]}
        ];

        function randomBlock() {
            const id = 1 + Math.floor(Math.random() * 7);
            return blocks[id];
        };

        function inRange(x,y) {
            return x>=0 && x<w && y>=0 && y<h;
        };

        function canPlace(block, x, y, rot) {
            for (const [dx,dy] of block.r[rot]) {
                const px = x + dx, py = y + dy;
                if (!inRange(px,py)) {
                    return false;
                }
                if (board[py][px] !== 0) {
                    return false;
                }
            }
            return true;
        };

        let curBlock = null;
        let nextBlock0 = null;
        let nextBlock1 = null;
        let nextBlock2 = null;
        let holdBlock = null;

        function initSpawn() {
            const block = randomBlock();
            const x = 3;
            const y = 0;
            const rot = 0;
            curBlock = {block, x, y, rot};

            const nblock0 = randomBlock();
            const nblock1 = randomBlock();
            const nblock2 = randomBlock();
            const nx = 0;
            nextBlock0 = {block: nblock0, x: nx, y, rot};
            nextBlock1 = {block: nblock1, x: nx, y, rot};
            nextBlock2 = {block: nblock2, x: nx, y, rot};
        };

        function spawn() {
            const block = nextBlock0.block;
            const x = 3;
            const y = 0;
            const rot = 0;
            if (!canPlace(block, x, y, rot)) {
                gameOver();
                return;
            }
            curBlock = {block, x, y, rot};
            nextBlock0 = nextBlock1;
            nextBlock1 = nextBlock2;
            const newBlock = randomBlock();
            const nx = 0;
            nextBlock2 = {block: newBlock, nx, y, rot};
        };

        function hold() {
            if (holdBlock == null) {
                holdBlock = curBlock;
                spawn();
                holdRender();
                return;
            }
            const block = holdBlock.block;
            const x = 3;
            const y = 0;
            const rot = 0;
            const cblock = curBlock.block;
            const hx = 0;
            curBlock = {block, x, y, rot};
            holdBlock = {block: cblock, x: hx, y, rot};
            holdRender();
        }

        function holdRender() {
            for (let y=0;y<4;y++) {
                for (let x=0;x<4;x++) {
                    hcells[y][x].style.backgroundColor = colors[0];
                }
            }
            for (const [x,y] of holdBlock.block.r[0]) {
                hcells[y][x].style.backgroundColor = colors[holdBlock.block.id];
            }
        }

        function move(dx, dy) {
            if (!running || !curBlock) {
                return false;
            }
            const nx = curBlock.x + dx;
            const ny = curBlock.y + dy;
            if (canPlace(curBlock.block, nx, ny, curBlock.rot)) {
                curBlock.x = nx;
                curBlock.y = ny;
                render();
                return true;
            }
            return false;
        };

        function rotate() {
            if (!curBlock) {
                return false;
            }
            const nr = (curBlock.rot+1)%4;
            if (canPlace(curBlock.block, curBlock.x, curBlock.y, nr)) {
                curBlock.rot = nr;
                render();
                return;
            }
            if (canPlace(curBlock.block, curBlock.x-1, curBlock.y, nr)) {
                curBlock.x -= 1;
                curBlock.rot = nr;
                render();
                return;
            }
            if (canPlace(curBlock.block, curBlock.x+1, curBlock.y, nr)) {
                curBlock.x += 1;
                curBlock.rot = nr;
                render();
                return;
            }
        };

        function lockBlock() {
            const id = curBlock.block.id;
            for (const [dx, dy] of curBlock.block.r[curBlock.rot]) {
                const px = curBlock.x + dx;
                const py = curBlock.y + dy;
                if (inRange(px,py)) {
                    board[py][px] = id;
                }
            }
            clearLines();
            spawn();
            render();
        };

        let score = 0;
        let lev = 0;
        let clear = 0;

        function clearLines() {
            let cleared = 0;
            for (let y=h-1;y>=0;y--) {
                if (board[y].every(v => v !== 0)) {
                    board.splice(y, 1);
                    board.unshift(Array(w).fill(0));
                    cleared++;
                    y++;
                }
            }
            if (cleared > 0) {
                let reclear = 1 + clear*0.2;
                score += lev * cleared * reclear * 1000;
                clear++;            
                const map = new Map([
                    [1, 0], [2, 1000],
                    [3, 2000], [4, 4000],
                    [5, 7000], [6, 10000],
                    [7, 15000], [8, 20000],
                    [9, 25000], [10, 30000]
                ]);
                while (score >= map.get(lev+1)) {
                    if (lev<10) {
                        lev++;
                    }
                }
                const levEl = document.querySelector("#lev");
                const scoreEl = document.querySelector("#score");
                levEl.textContent = `Lv. ${lev}`;
                scoreEl.textContent = `score ${score}`;
            } else {
                clear = 0;
            }
        };

        function render() {
            if (!running) {
                return;
            }
            for (let y=0;y<h;y++) {
                for (let x=0;x<w;x++) {
                    cells[y][x].style.backgroundColor = colors[board[y][x]];
                }
            }
            if (curBlock) {
                for (const [dx,dy] of curBlock.block.r[curBlock.rot]) {
                    const px = curBlock.x + dx;
                    const py = curBlock.y + dy;
                    if (inRange(px,py)) {
                        cells[py][px].style.backgroundColor = colors[curBlock.block.id];
                    }
                }
            }
            for (let y=0;y<4;y++) {
                for (let x=0;x<4;x++) {
                    ncells0[y][x].style.backgroundColor = colors[0];
                }
            }
            for (const [x,y] of nextBlock0.block.r[0]) {
                ncells0[y][x].style.backgroundColor = colors[nextBlock0.block.id];
            }
            for (let y=0;y<4;y++) {
                for (let x=0;x<4;x++) {
                    ncells1[y][x].style.backgroundColor = colors[0];
                }
            }
            for (const [x,y] of nextBlock1.block.r[0]) {
                ncells1[y][x].style.backgroundColor = colors[nextBlock1.block.id];
            }
            for (let y=0;y<4;y++) {
                for (let x=0;x<4;x++) {
                    ncells2[y][x].style.backgroundColor = colors[0];
                }
            }
            for (const [x,y] of nextBlock2.block.r[0]) {
                ncells2[y][x].style.backgroundColor = colors[nextBlock2.block.id];
            }
        };

        window.addEventListener('keydown', (e) => {
            if (!curBlock) {
                return false;
            }
            if (e.code === 'ArrowLeft') {
                move(-1,0);
            }
            if (e.code === 'ArrowRight') {
                move(1,0);
            }
            if (e.code === 'ArrowDown') {
                move(0,1);
            }
            if (e.code === 'ArrowUp') {
                rotate();
            }
            if (e.code === 'Space') {
                e.preventDefault();
                while (move(0,1)) {};
                lockBlock();
            }
            if (e.code === 'ShiftLeft') {
                hold();
            }
        });

        let loopId = null;
        let running = false;

        function levelDelay(lev) {
            return Number(1100 - lev*100);
        };

        function startLoop() {
            if (running) {
                return;
            }
            running = true;
            delayLoop();
        };

        function stopLoop() {
            running = false;
            if (loopId) {
                clearTimeout(loopId);
                loopId = null;
            }
        };

        function tick() {
            if (!running || !curBlock) {
                return;
            }
            if (!move(0,1)) {
                lockBlock();
            }
        };

        function delayLoop() {
            if(!running) {
                return;
            }
            const delay = levelDelay(lev);
            loopId = setTimeout(() => {
                tick();
                delayLoop();
            }, delay);
        };

        function gameOver() {
            stopLoop();
            running = false;

            document.querySelectorAll('.cell').forEach(cell => cell.remove());
            document.querySelectorAll('.mcell').forEach(mcell => mcell.remove());
            document.querySelectorAll('.mmcell').forEach(mmcell => mmcell.remove());

            boardEl.style.display = "";
            boardEl.style.gridTemplateColumns = "";
            boardEl.style.gridTemplateRows = "";

            document.getElementById('hwrap').style.display = "flex";
            document.getElementById('result').textContent = `score ${score}`;
            
            score = 0;
            clear = 0;

            cells = [];
            hcells = [];
            ncells0 = [];
            ncells1 = [];
            ncells2 = [];
    
            curBlock = null;
            nextBlock0 = null;
            nextBlock1 = null;
            nextBlock2 = null;
            holdBlock = null;

            board = Array.from({length: h}, () => Array(w).fill(0));
        };

        document.getElementById('btn').addEventListener('click',function() {
            const levelVal = document.querySelector("#level").value;
            const levEl = document.querySelector("#lev");
            const scoreEl = document.querySelector("#score");
            document.getElementById('bwrap').style.display = "none";
            lev = parseInt(levelVal);
            levEl.textContent = `Lv. ${lev}`;
            scoreEl.textContent = "score 0";
            initRender();
            initSpawn();
            startLoop();
            render();
        });

        document.getElementById('reBtn').addEventListener('click',function() {
            const levelVal = document.querySelector("#reLevel").value;
            const levEl = document.querySelector("#lev");
            const scoreEl = document.querySelector("#score");
            document.getElementById('hwrap').style.display = "none";
            lev = parseInt(levelVal);
            levEl.textContent = `Lv. ${lev}`;
            scoreEl.textContent = "score 0";
            initRender();
            initSpawn();
            startLoop();
            render();            
        });

    </script>
</body>
</html>